# TMP92CM22FG_Pico2 設計メモ

秋月で 100 円の東芝製CPU, TMP92CM22FG を動かしてみる。

* TMP92CM22FG は QFP-100パッケージ。TLCS-900/H1シリーズに属する。
* TLCS-900/H1 は Z80 類似(拡張)レジスタセットを持つ。アセンブリニーモニックレベルで互換性がありそう。機械語レベルで互換性はない。
* 32bit CPU だが、当初は 64bit Pico2内蔵メモリをROM/RAMとして駆動する。
* 駆動電圧は 3.3V とする。Pico2 から給電する。消費電力定格 600mW なので、200mA 程度は必要になる。足りなさそうなら外部 LDO を入れる。
* 外部クロックで動かす。外部クロック駆動時には制御レジスタの該当ビットを立てる必要がある。立てなくても動作しそうだがノイズ耐性が落ちるようだ。
* 起動直後は、入力クロックの 1/32 周波数で動作する。レジスタ書き込みで入力クロックの 1/2 まで上げることができる。
* PIO により単相クロックを生成する。分周比は 1/16 で 7.8MHz、CPU動作周波数は 244kHz ぐらいでどうだろうか。
* WAIT入力: P76が対応する。リセット直後は入力モード、ただし内部設定で WAIT 入力を見ないモードにある。起動直後に WAIT 入力を有効にしてクロックを上げる(ギアを上げる)ことを目指す。
* メモリマップドI/O、かつ、リセットベクタを FFFF00,1,2 から取り出す。
* FFFFXX(最後の256バイト)に各種ベクトルが置かれる。UART は、FFFEXX (FEXX) に割り当てることとする。
* NOP は 00H、プルダウンしてクロックだけ供給して動作を見る。
* CPUモード設定を動かす。外部クロックビット、WAIT 入力有効を設定し、WAIT が利いていることを確認する。
* リセットベクタを供給し 0000 番地から実行開始することを確認する。 
* アセンブラで簡単な命令をアセンブル・動かしてみる。アセンブラが使えることの確認。メモリインクリメントを連続させる。
* クロック分周比を上げる。最終的に 1/1 での動作を確認する。おそらく 1WAIT入る。
* UART エコーバック動作を確認する。
* Z80用BASIC、例えば EMUBASIC をアセンブルして動かしてみる。ASCIIART.BAS まで。
* 次に FORTH を動かしてみる。MUL/DIV命令があるので行けそう。

## クロック

* 最低で fc=4MHz/tOSC=250nsなので、4MHzクロックから始める。
* このとき、1/16 で CLKOUT 8000ns (0.125MHz)取れるのでノーウェイトで十分対応できる。

## メモリアクセス。

* CSx がサイクルの開始を示す、訳でもないかもしれない。常時アサートされている可能性が高い。
* 半CLKOUT周期後に RD/WRが落ちる。RD or WR でサイクル開始を検出する。
* アクセスタイム概算は、1.5Tである。300nsとすると、クロック 200ns == 5MHz となる。　WAIT有効にできれば、fc=10MHz, tOSC=5MHz で動かすとよいだろう。

